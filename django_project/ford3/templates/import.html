<table id="main_result"></table>
{% csrf_token %}
<script type='text/javascript'>

    const class_delimiter = '__'
    const getCSRFToken = () => {
        return document.querySelector('input[name="csrfmiddlewaretoken"]').value
    }

    const processQualification = (providerId, data, idx, columns) => {
        url = '/providers/' + providerId + '/qualifications/import/'
        let headers = false
        if (idx == 0) {
            headers = true
        }

        const request = new XMLHttpRequest()
        request.open('POST', url, true)
        request.setRequestHeader('Content-Type', 'application/json')
        request.setRequestHeader('X-CSRFToken', getCSRFToken());

        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                const result = JSON.parse(request.responseText)

                console.log(result)
                update_result(columns, request.responseText, headers)
            }
        }
        let result = request.send(JSON.stringify(data))
        return result
    }

    const main = () => {
        const data = JSON.parse('{{ data|safe }}')
        const columns = JSON.parse('{{ columns|safe }}')
        const providerId = '{{ provider.id|safe }}'
        let error_log = []

        data.forEach((row, idx) => {

            error_log.push(processQualification(providerId, row, idx, columns))
        })

    }


    const getValue = (oldValue) => {
        if (oldValue == undefined) return ''
        if (oldValue.toString() == "false") {
            return "False"
        } else if (oldValue.toString() == "true") {
            return "True"
        } else return oldValue
    }

    const update_result = (columns, rowReport, headers) => {

        let main_result_div = document.getElementById("main_result")
        let result_object = JSON.parse(rowReport)
        let diffs = result_object['result']['diffs']
        let errors = result_object['result']['errors']

        let header_arr = []
        let value_arr = []

        for (var column of columns) {
            let key = column['key']
            let name = column['name']
            if (key in diffs) {
                let header = `<th class="difference">${name}</th>`  // Saqa qualification requirement subject name
                let old_value = getValue(diffs[key]['old'])
                let new_value = getValue(diffs[key]['new'])
                var next_cell = ''
                if (old_value == new_value) {
                    next_cell = `<td class='value_same'>${new_value}</td>`
                } else {
                    next_cell = `<td class='value_changed'><div class='old_value'>${old_value}</div><div class='new_value'>${new_value}</div></td>`
                }
                header_arr.push(`${header}`)
                value_arr.push(next_cell)
            }
            if (key in errors) {
                header_arr.push(`<th>${name}</th>`)
                value_arr.push(`<td class="error">${errors[key]}</td>`)
            }
        }
        let header_row = '<tr>'
        for (var next_value of header_arr) {
            header_row += `${next_value}`
        }
        header_row += '</tr>'

        let value_row = '<tr>'
        for (var next_value of value_arr) {
            value_row += `${next_value}`
        }
        value_row += '</tr>'
        if (!headers) {
            header_row = ''
        }
        let result = `${header_row}${value_row}`
        main_result_div.innerHTML += result

    }

    const get_diff_html = (diffs) => {
        let class_arr = []
        let field_arr = []
        let old_array = []
        let new_arr = []
        for (var key of Object.keys(diffs)) {
            let class_name = key.slice(0, key.indexOf(class_delimiter))
            let field_name = key.slice(key.indexOf(class_delimiter) + class_delimiter.length, key.length)
            class_arr.push(class_name)
            field_arr.push(field_name)
            let old_value = (diffs[key]['old'] == undefined ? '&nbsp' : diffs[key]['old'])
            let new_value = (diffs[key]['new'] == undefined ? '&nbsp' : diffs[key]['new'])
            old_array.push(old_value)
            new_arr.push(new_value)
        }

        let old_arr = old_array.map(function (e) {
            if (e == false) {
                e = "False"
            }
            if (e == true) {
                e = "True"
            }
            return e;
        });
        let header_row = getHeadingArrayHtml(class_arr, "header_row", "th")
        let field_row = getHeadingArrayHtml(field_arr, "field_arr", "td")
        {#let old_row = getSimpleRow(old_arr, "old_arr")#}
        {#let new_row = getSimpleRow(new_arr, "new_arr")#}
        {##}

        let difference_row = getDifferenceRows(old_arr, new_arr, field_arr.length)
        let content = `<table id='difference_table'>${header_row}${field_row}${difference_row}</table>`
        return content
    }


    const getDifferenceRows = (old_arr, new_arr, length) => {
        let difference_row = '<tr class="difference_row">'

        {#difference_row += '<td><div class="old_header">Old</div>' +#}
        {#    '            <div class="new_header">New</div></td>'#}
        let next_cell = ''
        for (let i = 0; i < length; i++) {
            let old_value = old_arr[i]
            let new_value = new_arr[i]
            if (old_value == new_value) {
                next_cell = `<td class='value_same'>
                        <div class='value_same_value'>${new_value}</div>`
            } else {
                next_cell = `<td class='value_changed'>
                        <div class='old_value'>${old_value}</div>
                        <div class='new_value'>${new_value}</div></td>`
            }
            difference_row += next_cell
        }
        difference_row += '</tr>'
        return difference_row
    }

    const getSimpleRow = (rowArray, rowName) => {
        let row = '<tr>'
        for (var field of rowArray) {
            row += `<td class='${rowName}'>${field}</td>`
        }
        row += '</tr>'
        return row
    }

    const getHeadingArrayHtml = (rowArray, rowName, tag) => {
        let row = `<tr class="${rowName}">`
        for (let i = 0; i < rowArray.length; i++) {
            let original_heading = rowArray[i]
            let heading = original_heading.toString().replace('_', ' ')
            heading = toTitleCase(heading)
            if ((i > 0) && (original_heading == rowArray[i - 1])) {
                row += `<${tag} class="empty_heading"></${tag}>`
            } else {
                row += `<${tag}>${heading}</${tag}>`
            }
        }
        row += '</tr>'
        return row
    }

    function toTitleCase(str) {
        return str.replace(
            /\w\S*/g,
            function (txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            }
        );
    }

    main()

    //# sourceURL=import_html.js
</script>

<style>

    td.value_changed {
        background-color: green;
    }

    .old_header {
        width: 100%;
        border-bottom: solid;
    }

    .new_header {
        width: 100%;
    }

    .old_value {
        width: 100%;
        border-bottom: solid;
    }

    .new_value {
        width: 100%;
    }

    #difference_table {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

    #difference_table td, #difference_table th {
        border: 1px solid #ddd;
        padding: 8px;
    }

    #difference_table tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #difference_table tr:hover {
        background-color: #ddd;
    }

    #difference_table th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #4CAF50;
        color: white;
    }

    .error {
        background-color: red;
    }
</style>